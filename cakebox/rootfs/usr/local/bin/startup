#!/bin/sh

addgroup -g ${GID} cakebox && adduser -h /home/cakebox -s /bin/sh -G cakebox -D -u ${UID} cakebox

mkdir -p /data

if [ $WEBROOT != "/" ]; then
    sed -i -e 's|#rewrite|rewrite|g' /etc/nginx/nginx.conf
fi
sed -i -e 's|<webroot>|'${WEBROOT}'|g' \
        -e 's|<username>|'${USERNAME}'|g' /etc/nginx/nginx.conf

sed -e 's|$app["cakebox.root"].*$|$app["cakebox.root"] = "/data";|g' \
        -e 's|$app["cakebox.access"].*$|$app["cakebox.access"] = "/access/'${USERNAME}'";|g' \
        -e 's|$app["cakebox.host"].*$|$app["cakebox.host"] = "'${PROTO}'://'${DOMAIN}'";|g' /var/www/html/cakebox/config/default.php.dist > /var/www/html/cakebox/config/${USERNAME}.php

chown -R cakebox:cakebox /data /var/www /etc/s6.d /home/cakebox /var/lib/nginx /etc/php7 /etc/nginx /var/log /tmp

if [ $# -eq 0 ]; then
    exec su-exec cakebox:cakebox /bin/s6-svscan /etc/s6.d
else
    exec su-exec cakebox:cakebox $@
fi
