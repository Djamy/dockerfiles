#!/bin/sh

## Variables
CSI="\033["
CEND="${CSI}0m"
CRED="${CSI}1;31m"
CGREEN="${CSI}1;32m"
CYELLOW="${CSI}1;33m"
CBLUE="${CSI}1;34m"

## Functions
f_log() {
    LOG_TYPE=$1
    LOG_MESSAGE=$2

    case "${LOG_TYPE}" in
    "INF")
        echo -e "${CBLUE}=INF= $(date +%Y/%m/%d-%H:%M:%S) ${LOG_MESSAGE}${CEND}"
    ;;
    "WRN")
        echo -e "${CYELLOW}=WRN= $(date +%Y/%m/%d-%H:%M:%S) ${LOG_MESSAGE}${CEND}"
    ;;
    "ERR")
        echo -e "${CRED}=ERR= $(date +%Y/%m/%d-%H:%M:%S) ${LOG_MESSAGE}${CEND}"
    ;;
    esac
}

f_check_selfsigned() {
    CERTFILE=/nginx/ssl/selfsigned/fullchain.pem
    if [ ! -e ${CERTFILE} ] && [ ! -e ${KEYFILE} ]; then
        if openssl x509 -checkend 864000 -noout -in "$CERTFILE"; then
            f_log INF "Selfsigned Certificate is good for another 10 days!"
        else
            f_log INF "Generate New Selfsigned Certificate"
            openssl req -new -newkey rsa:4096 -days 3658 -sha256 -nodes -x509 \
                -subj "/C=FR/ST=France/L=Paris/O=${FRONTEND_DOMAIN}/OU=${container_name}/CN=*/emailAddress=postmaster@${FRONTEND_DOMAIN}" \
                -keyout "$KEYFILE" \
                -out "$CERTFILE"
            [[ $? == 0 ]] && f_log INF "New Selfsigned Certificate generated" || f_log ERR "New Selfsigned Certificate not generated"
        fi       
    fi 
}

f_check_le() {
    LIST_DOMAINS=$(ls /nginx/ssl/certificates | grep .crt)

    for domain in ${LIST_DOMAINS}; do 
        if openssl x509 -checkend 864000 -noout -in "/nginx/ssl/certificates/${domain}.crt"; then
            f_log INF "Certificate is good for another 10 days!"
        else
            f_log INF "Generate New Certificate for ${domain}"
            /usr/local/bin/lego -a -m ${EMAIL} --domain ${domain} --path /nginx/ssl --webroot /nginx/www/${domain} revoke
            if [ $? == 0 ]; then
                rm -rf /nginx/ssl/certificates/${domain}.*
                /usr/local/bin/lego -a -m ${EMAIL} --domain ${domain} --path /nginx/ssl --webroot /nginx/www/${domain} --key ${FRONTEND_SSLTYPE} run
                [[ $? == 0 ]] && f_log INF "New Certificate for ${domain} generated" || f_log ERR "New Certificate for ${domain} not generated"
            else
                f_log ERR "New Certificate for ${domain} not revoke"
            fi
        fi             
    done
}

f_check_selfsigned